#!/bin/sh
#
# mksystem - Adapt system_stm32f2xx.c to our needs
#
# Developed by Werner Almesberger for Actility S.A., and
# licensed under LGPLv2 by Actility S.A.
#

cat <<EOF
/*
 * MACHINE-GENERATED. DO NOT EDIT !
 *
 *
 * Generator:		$0
 * Original file:	$1
 */

EOF

#
# PLL rules on STM32F2xx:
#
# - PLLQ in 2...15
# - VCOout/PLLQ = 48 MHz if USB
# - PLLP in 2, 4, 6, 8
# - SYSCLK <= 120 MHz
# - PLLN in 64...432
# - VCOout in 64...432 MHz
# - PLLM in 2...63
# - VCCin in 1...2 MHz
#

#
# WM-N-BM-09 has a 26 MHz crystal
#
# This sets the PLL as follows:
#
# PLL_M = 13	XTAL / PLL_M = VCOin		26 MHz / 13 = 2 MHz
# PLL_N	= 120	VCOin * PLL_N = VCOout		2 MHz * 120 = 240 MHz
# PLL_P = 2	VCCOout / PLL_P = SYSCLK	240 MHz / 2 = 120 MHz
# PLL_Q = 7	VCCout / PLL_Q = 48 MHz clock	240 MHz / 5 = 48 MHz
#

sed -e 's/\(#define PLL_M\).*/\1 13/' \
    -e 's/\(#define PLL_N\).*/\1 120/' \
    -e 's/\(#define PLL_P\).*/\1 2/' \
    -e 's/\(#define PLL_Q\).*/\1 5/' \
    "$1"
